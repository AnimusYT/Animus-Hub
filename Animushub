local camera = workspace.CurrentCamera

local ESPEnabled = true
local useTeamCheck = true

local players = game.Players
local runService = game:GetService("RunService")
local localPlayer = players.LocalPlayer
local lines = {}

-- Function to create or update ESP lines
local function updateLine(player)
    if not ESPEnabled then
        if lines[player] then
            lines[player].Visible = false
        end
        return
    end

    if player ~= localPlayer and player.Character and player.Character:FindFirstChild("HumanoidRootPart") then
        local hrp = player.Character.HumanoidRootPart
        local vector, onScreen = camera:WorldToScreenPoint(hrp.Position)
        
        -- Create a new line if it doesn't exist
        if not lines[player] then
            local line = Drawing.new("Line")
            line.Color = Color3.fromRGB(255, 80, 60)
            line.Thickness = 2
            line.Transparency = 1
            lines[player] = line
        end
        
        local line = lines[player]
        line.Visible = onScreen
        if onScreen then
            line.From = Vector2.new(camera.ViewportSize.X / 2, camera.ViewportSize.Y / 2)
            line.To = Vector2.new(vector.X, vector.Y)
        end
    elseif lines[player] then
        lines[player].Visible = false
    end
end

-- Update ESP for all players
local function updateAllPlayers()
    for _, player in pairs(players:GetPlayers()) do
        if not useTeamCheck or player.Team ~= localPlayer.Team then
            updateLine(player)
        end
    end
end

-- Connect to RenderStepped for continuous updates
runService.RenderStepped:Connect(updateAllPlayers)

-- Handle new players
players.PlayerAdded:Connect(function(player)
    player.CharacterAdded:Connect(function()
        repeat wait() until player.Character and player.Character:FindFirstChild("HumanoidRootPart")
        updateLine(player)
    end)
end)

-- Clean up lines for players who leave
players.PlayerRemoving:Connect(function(player)
    if lines[player] then
        lines[player]:Remove()
        lines[player] = nil
    end
end)
